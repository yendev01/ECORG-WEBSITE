{% assign emptyarray = "" | split: "," %}
{% assign data = site.data[include.data] 
  | default: site[include.data] 
  | default: emptyarray 
  | data_filter: include.filters 
%}

{% assign hideyear = include.hideyear | default: "false" %}

{% assign years = data 
  | group_by_exp: "d", "d.date | date: '%Y'" 
  | sort: "name" 
  | reverse 
%}

{% for year in years %}
  {% assign year_data = year.items %}

  {% if years.size > 1 and hideyear == "false" %}
### {{ year.name }}

{% assign year_data = year_data | sort: "date" | reverse %}
  {% elsif years.size > 1 and hideyear == "true" %}
    {% assign year_data = year_data | sort: "date" | reverse %}
  {% endif %}

  {% comment %} Check if this is member data (has role field) or other data like citations {% endcomment %}
  {% assign is_member_data = false %}
  {% for item in year_data %}
    {% if item.role %}
      {% assign is_member_data = true %}
      {% break %}
    {% endif %}
  {% endfor %}

  {% if is_member_data %}
    {% comment %} MEMBER SORTING LOGIC - Role-based ordering {% endcomment %}
    {% assign member_order = site.data.member_order %}
    {% assign roles = year_data | group_by: "role" %}
    {% assign final_sorted_data = "" | split: "," %}

    {% for role_group in roles %}
      {% assign current_role = role_group.name | default: "default" %}
      {% assign role_members = role_group.items %}
      
      {% assign role_order = member_order[current_role] | default: member_order["default"] | default: emptyarray %}
      {% assign role_sorted_data = "" | split: "," %}
      
      {% comment %} Check for potential name conflicts to determine matching strategy {% endcomment %}
      {% assign has_similar_names = false %}
      {% assign all_first_last_pairs = "" | split: "," %}
      
      {% for member in role_members %}
        {% assign member_name = member.name | default: "" | downcase | replace: "dr. ", "" | replace: "prof. ", "" | replace: "mr. ", "" | replace: "ms. ", "" | replace: "mrs. ", "" | strip %}
        {% assign words = member_name | split: " " %}
        {% assign clean_words = "" | split: "," %}
        {% for word in words %}
          {% assign clean_word = word | replace: ".", "" | replace: ",", "" | strip %}
          {% if clean_word != "" %}
            {% assign clean_words = clean_words | push: clean_word %}
          {% endif %}
        {% endfor %}
        
        {% if clean_words.size >= 2 %}
          {% assign first_word = clean_words[0] %}
          {% assign last_word = clean_words[-1] %}
          {% assign pair = first_word | append: " " | append: last_word %}
          
          {% for existing_pair in all_first_last_pairs %}
            {% if existing_pair == pair %}
              {% assign has_similar_names = true %}
              {% break %}
            {% endif %}
          {% endfor %}
          
          {% assign all_first_last_pairs = all_first_last_pairs | push: pair %}
        {% endif %}
      {% endfor %}
      
      {% comment %} First pass: Add members in the specified order for this role {% endcomment %}
      {% for ordered_name in role_order %}
        {% assign ordered_name_normalized = ordered_name | downcase | replace: "dr. ", "" | replace: "prof. ", "" | replace: "mr. ", "" | replace: "ms. ", "" | replace: "mrs. ", "" | strip %}
        
        {% assign ordered_words = ordered_name_normalized | split: " " %}
        {% assign ordered_words_clean = "" | split: "," %}
        {% for word in ordered_words %}
          {% assign clean_word = word | replace: ".", "" | replace: ",", "" | strip %}
          {% if clean_word != "" %}
            {% assign ordered_words_clean = ordered_words_clean | push: clean_word %}
          {% endif %}
        {% endfor %}
        
        {% for member in role_members %}
          {% assign member_full_name = member.name | default: "" %}
          {% assign member_name_normalized = member_full_name | downcase | replace: "dr. ", "" | replace: "prof. ", "" | replace: "mr. ", "" | replace: "ms. ", "" | replace: "mrs. ", "" | strip %}
          
          {% assign member_words = member_name_normalized | split: " " %}
          {% assign member_words_clean = "" | split: "," %}
          {% for word in member_words %}
            {% assign clean_word = word | replace: ".", "" | replace: ",", "" | strip %}
            {% if clean_word != "" %}
              {% assign member_words_clean = member_words_clean | push: clean_word %}
            {% endif %}
          {% endfor %}
          
          {% assign is_match = false %}
          
          {% if has_similar_names %}
            {% if ordered_words_clean.size == member_words_clean.size %}
              {% assign words_match = true %}
              {% for ordered_word in ordered_words_clean %}
                {% assign word_found = false %}
                {% for member_word in member_words_clean %}
                  {% if member_word == ordered_word %}
                    {% assign word_found = true %}
                    {% break %}
                  {% endif %}
                {% endfor %}
                {% unless word_found %}
                  {% assign words_match = false %}
                  {% break %}
                {% endunless %}
              {% endfor %}
              {% if words_match %}
                {% assign is_match = true %}
              {% endif %}
            {% endif %}
          {% else %}
            {% if ordered_words_clean.size >= 2 and member_words_clean.size >= 2 %}
              {% assign ordered_first = ordered_words_clean[0] %}
              {% assign ordered_last = ordered_words_clean[-1] %}
              {% assign member_first = member_words_clean[0] %}
              {% assign member_last = member_words_clean[-1] %}
              
              {% if ordered_first == member_first and ordered_last == member_last %}
                {% assign is_match = true %}
              {% endif %}
            {% endif %}
            
            {% unless is_match %}
              {% assign words_match = true %}
              {% for ordered_word in ordered_words_clean %}
                {% assign word_found = false %}
                {% for member_word in member_words_clean %}
                  {% if member_word == ordered_word %}
                    {% assign word_found = true %}
                    {% break %}
                  {% endif %}
                {% endfor %}
                {% unless word_found %}
                  {% assign words_match = false %}
                  {% break %}
                {% endunless %}
              {% endfor %}
              {% if words_match %}
                {% assign is_match = true %}
              {% endif %}
            {% endunless %}
          {% endif %}
          
          {% if is_match %}
            {% assign role_sorted_data = role_sorted_data | push: member %}
            {% break %}
          {% endif %}
        {% endfor %}
      {% endfor %}
      
      {% comment %} Second pass: Add remaining members from this role that weren't in the order list {% endcomment %}
      {% for member in role_members %}
        {% assign member_full_name = member.name | default: "" %}
        {% assign member_name_normalized = member_full_name | downcase | replace: "dr. ", "" | replace: "prof. ", "" | replace: "mr. ", "" | replace: "ms. ", "" | replace: "mrs. ", "" | strip %}
        
        {% assign member_words = member_name_normalized | split: " " %}
        {% assign member_words_clean = "" | split: "," %}
        {% for word in member_words %}
          {% assign clean_word = word | replace: ".", "" | replace: ",", "" | strip %}
          {% if clean_word != "" %}
            {% assign member_words_clean = member_words_clean | push: clean_word %}
          {% endif %}
        {% endfor %}
        
        {% assign found_in_order = false %}
        {% for ordered_name in role_order %}
          {% assign ordered_name_normalized = ordered_name | downcase | replace: "dr. ", "" | replace: "prof. ", "" | replace: "mr. ", "" | replace: "ms. ", "" | replace: "mrs. ", "" | strip %}
          
          {% assign ordered_words = ordered_name_normalized | split: " " %}
          {% assign ordered_words_clean = "" | split: "," %}
          {% for word in ordered_words %}
            {% assign clean_word = word | replace: ".", "" | replace: ",", "" | strip %}
            {% if clean_word != "" %}
              {% assign ordered_words_clean = ordered_words_clean | push: clean_word %}
            {% endif %}
          {% endfor %}
          
          {% assign is_match = false %}
          
          {% if has_similar_names %}
            {% if ordered_words_clean.size == member_words_clean.size %}
              {% assign words_match = true %}
              {% for ordered_word in ordered_words_clean %}
                {% assign word_found = false %}
                {% for member_word in member_words_clean %}
                  {% if member_word == ordered_word %}
                    {% assign word_found = true %}
                    {% break %}
                  {% endif %}
                {% endfor %}
                {% unless word_found %}
                  {% assign words_match = false %}
                  {% break %}
                {% endunless %}
              {% endfor %}
              {% if words_match %}
                {% assign is_match = true %}
              {% endif %}
            {% endif %}
          {% else %}
            {% if ordered_words_clean.size >= 2 and member_words_clean.size >= 2 %}
              {% assign ordered_first = ordered_words_clean[0] %}
              {% assign ordered_last = ordered_words_clean[-1] %}
              {% assign member_first = member_words_clean[0] %}
              {% assign member_last = member_words_clean[-1] %}
              
              {% if ordered_first == member_first and ordered_last == member_last %}
                {% assign is_match = true %}
              {% endif %}
            {% endif %}
            
            {% unless is_match %}
              {% assign words_match = true %}
              {% for ordered_word in ordered_words_clean %}
                {% assign word_found = false %}
                {% for member_word in member_words_clean %}
                  {% if member_word == ordered_word %}
                    {% assign word_found = true %}
                    {% break %}
                  {% endif %}
                {% endfor %}
                {% unless word_found %}
                  {% assign words_match = false %}
                  {% break %}
                {% endunless %}
              {% endfor %}
              {% if words_match %}
                {% assign is_match = true %}
              {% endif %}
            {% endunless %}
          {% endif %}
          
          {% if is_match %}
            {% assign found_in_order = true %}
            {% break %}
          {% endif %}
        {% endfor %}
        
        {% unless found_in_order %}
          {% assign role_sorted_data = role_sorted_data | push: member %}
        {% endunless %}
      {% endfor %}
      
      {% for member in role_sorted_data %}
        {% assign final_sorted_data = final_sorted_data | push: member %}
      {% endfor %}
    {% endfor %}

    {% assign sorted_year_data = final_sorted_data %}
  {% else %}
    {% comment %} SIMPLE SORTING - For citations and other non-member data {% endcomment %}
    {% assign sorted_year_data = year_data %}
  {% endif %}

  {% for d in sorted_year_data %}
    {% assign style = d.style | default: include.style %}

    {% 
      include {{ include.component | append: ".html" }} 
      author=d.author 
      authors=d.authors 
      buttons=d.buttons 
      caption=d.caption 
      content=d.content 
      date=d.date 
      description=d.description 
      excerpt=d.excerpt 
      height=d.height 
      icon=d.icon 
      id=d.id 
      image=d.image 
      last_modified_at=d.last_modified_at 
      link=d.link 
      lookup=d.lookup 
      name=d.name 
      publisher=d.publisher 
      repo=d.repo 
      role=d.role 
      external-page-only = d.external-page-only 
      brief-desc = d.brief-desc 
      affiliations = d.affiliations 
      brief-position = d.brief-position 
      position=d.position 
      slug=d.slug 
      style=style 
      subtitle=d.subtitle 
      tags=d.tags 
      text=d.text 
      title=d.title 
      tooltip=d.tooltip 
      type=d.type 
      url=d.url 
      width=d.width 
    %}
  {% endfor %}
{% endfor %}